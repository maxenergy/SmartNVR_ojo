# ZLMediaKit å´©æºƒåˆ†ææœ€ç»ˆæŠ¥å‘Š

## ğŸ¯ è°ƒè¯•æ€»ç»“

**æ—¥æœŸ**: 2025-07-18  
**ç‰ˆæœ¬**: e876b59e3c9a4e18f4a7d2094a897b4c00494bf0  
**å¹³å°**: RK3588 Android  
**æµ‹è¯•åœºæ™¯**: 4è·¯RTSPæµ + YOLOv5æ¨ç†  

## ğŸš¨ å‘ç°å¹¶ä¿®å¤çš„é—®é¢˜

### 1. **å†…å­˜æ³„æ¼é—®é¢˜** âœ… **å·²å®Œå…¨è§£å†³**

#### A. new/freeä¸åŒ¹é… (ZLPlayer.cpp:873)
```cpp
// é—®é¢˜: ä½¿ç”¨free()é‡Šæ”¾new[]åˆ†é…çš„å†…å­˜
this->modelFileContent = new char[dataLen];  // ç¬¬49è¡Œ
free(modelFileContent);  // ç¬¬873è¡Œ âŒ

// ä¿®å¤: ä½¿ç”¨delete[]é‡Šæ”¾new[]åˆ†é…çš„å†…å­˜
delete[] modelFileContent;  // âœ…
```

#### B. malloc/delete[]ä¸åŒ¹é… (ZLPlayer.cpp:64)
```cpp
// é—®é¢˜: ä½¿ç”¨malloc()åˆ†é…ä½†ç”¨delete[]é‡Šæ”¾
this->modelFileContent = (char *) malloc(modelSize);  // âŒ

// ä¿®å¤: ç»Ÿä¸€ä½¿ç”¨new[]åˆ†é…
this->modelFileContent = new char[modelSize];  // âœ…
```

#### C. frame_data_tç»“æ„ä½“å†…å­˜æ³„æ¼ (user_comm.h)
```cpp
// é—®é¢˜: æ¯å¸§3.6MBæ•°æ®ä»æœªé‡Šæ”¾
typedef struct g_frame_data_t {
    char *data;  // ä»æœªé‡Šæ”¾ï¼
    // ... å…¶ä»–å­—æ®µ
} frame_data_t;

// ä¿®å¤: æ·»åŠ ææ„å‡½æ•°è‡ªåŠ¨é‡Šæ”¾
typedef struct g_frame_data_t {
    char *data;
    // ... å…¶ä»–å­—æ®µ
    
    ~g_frame_data_t() {
        if (data) {
            delete[] data;
            data = nullptr;
        }
    }
    
    g_frame_data_t() : data(nullptr), /* åˆå§‹åŒ–å…¶ä»–å­—æ®µ */ {}
} frame_data_t;
```

### 2. **MPPè§£ç å™¨ç©ºæŒ‡é’ˆè®¿é—®é—®é¢˜** âœ… **å·²ä¿®å¤**

#### A. mpp_frameç©ºæŒ‡é’ˆè®¿é—® (mpp_decoder.cpp:306)
```cpp
// é—®é¢˜: ç›´æ¥ä½¿ç”¨frameè€Œæ²¡æœ‰æ£€æŸ¥æ˜¯å¦ä¸ºç©º
frm_eos = mpp_frame_get_eos(frame);  // âŒ å¯èƒ½ç©ºæŒ‡é’ˆè®¿é—®

// ä¿®å¤: æ·»åŠ ç©ºæŒ‡é’ˆæ£€æŸ¥
if (frame != NULL) {
    frm_eos = mpp_frame_get_eos(frame);
    ret = mpp_frame_deinit(&frame);
    frame = NULL;
} else {
    LOGD("Warning: frame is NULL before mpp_frame_get_eos, skipping");
    frm_eos = 1;
}
```

#### B. mpp_packetç©ºæŒ‡é’ˆè®¿é—® (mpp_decoder.cpp:393)
```cpp
// é—®é¢˜: ç›´æ¥é‡Šæ”¾packetè€Œæ²¡æœ‰æ£€æŸ¥æ˜¯å¦ä¸ºç©º
mpp_packet_deinit(&packet);  // âŒ å¯èƒ½ç©ºæŒ‡é’ˆè®¿é—®

// ä¿®å¤: æ·»åŠ ç©ºæŒ‡é’ˆæ£€æŸ¥
if (packet != NULL) {
    mpp_packet_deinit(&packet);
    packet = NULL;
} else {
    LOGD("Warning: packet is NULL in deinit, skipping");
}
```

#### C. callbackè°ƒç”¨å®‰å…¨æ€§å¢å¼º
```cpp
// ä¿®å¤: åœ¨callbackè°ƒç”¨å‰æ£€æŸ¥æ‰€æœ‰æŒ‡é’ˆ
if (callback != nullptr && frame != NULL) {
    MppBuffer buffer = mpp_frame_get_buffer(frame);
    if (buffer != NULL) {
        char *data_vir = (char *)mpp_buffer_get_ptr(buffer);
        if (data_vir != NULL) {
            callback(/* å‚æ•° */);
        } else {
            LOGD("Warning: data_vir is NULL, skipping callback");
        }
    } else {
        LOGD("Warning: frame buffer is NULL, skipping callback");
    }
}
```

### 3. **ZLMediaKitç½‘ç»œé…ç½®é—®é¢˜** âš ï¸ **å¾…è§£å†³**

#### å´©æºƒåŸå› 
```
E libc++abi: terminating with uncaught exception of type std::invalid_argument: 
Not ip address: report.zlmediakit.com
F libc: Fatal signal 6 (SIGABRT), code -1 (SI_QUEUE) in tid 14304 (work poller 2)
```

**é—®é¢˜**: ZLMediaKitå°è¯•å°†åŸŸå `report.zlmediakit.com` è§£æä¸ºIPåœ°å€å¤±è´¥

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### **ä¿®å¤å‰ (åŸå§‹ç‰ˆæœ¬)**
- **è¿è¡Œæ—¶é•¿**: 30-50ç§’åå´©æºƒ
- **å´©æºƒç±»å‹**: `signal 11 (SIGSEGV)` - æ®µé”™è¯¯
- **å†…å­˜çŠ¶æ€**: 894MB â†’ 907MB æŒç»­å¢é•¿
- **å†…å­˜æ³„æ¼**: ä¸¥é‡ (æ¯å¸§3.6MBæ³„æ¼)

### **ç¬¬ä¸€æ¬¡ä¿®å¤å (å†…å­˜æ³„æ¼ä¿®å¤)**
- **è¿è¡Œæ—¶é•¿**: 1åˆ†30ç§’åå´©æºƒ
- **å´©æºƒç±»å‹**: `signal 11 (SIGSEGV)` - æ®µé”™è¯¯
- **å†…å­˜çŠ¶æ€**: 971MB-1002MB ç¨³å®šæ³¢åŠ¨
- **å†…å­˜æ³„æ¼**: âœ… å·²è§£å†³

### **ç¬¬äºŒæ¬¡ä¿®å¤å (MPPç©ºæŒ‡é’ˆä¿®å¤)**
- **è¿è¡Œæ—¶é•¿**: 4åˆ†56ç§’åå´©æºƒ ğŸ‰
- **å´©æºƒç±»å‹**: `signal 6 (SIGABRT)` - ç¨‹åºå¼‚å¸¸ç»ˆæ­¢
- **å†…å­˜çŠ¶æ€**: 973MB-1057MB ç¨³å®šæ³¢åŠ¨ (84MBèŒƒå›´)
- **å†…å­˜æ³„æ¼**: âœ… å®Œå…¨è§£å†³
- **æœ€å¤§å¢é•¿**: ä»…27MB (ä¼˜ç§€)

### **å…³é”®æ”¹è¿›æŒ‡æ ‡**
- **è¿è¡Œæ—¶é•¿æå‡**: 30ç§’ â†’ 296ç§’ (**æå‡986%**)
- **å†…å­˜ç¨³å®šæ€§**: ä»æŒç»­å¢é•¿å˜ä¸ºç¨³å®šæ³¢åŠ¨
- **å´©æºƒç±»å‹æ”¹å˜**: ä»ç©ºæŒ‡é’ˆè®¿é—®å˜ä¸ºç½‘ç»œé…ç½®é—®é¢˜

## ğŸ¯ å½“å‰çŠ¶æ€è¯„ä¼°

### âœ… **å·²å®Œå…¨è§£å†³çš„é—®é¢˜**
1. **å†…å­˜æ³„æ¼**: ä¸‰ä¸ªå…³é”®å†…å­˜æ³„æ¼é—®é¢˜å·²å®Œå…¨ä¿®å¤
2. **ç©ºæŒ‡é’ˆè®¿é—®**: MPPè§£ç å™¨çš„ç©ºæŒ‡é’ˆè®¿é—®å·²ä¿®å¤
3. **å†…å­˜ç¨³å®šæ€§**: RSSå†…å­˜ä½¿ç”¨ç¨³å®šï¼Œæ— æŒç»­å¢é•¿
4. **è¿è¡Œæ—¶é•¿**: ä»30ç§’æå‡åˆ°è¿‘5åˆ†é’Ÿ

### âš ï¸ **å¾…è§£å†³çš„é—®é¢˜**
1. **ZLMediaKitç½‘ç»œé…ç½®**: åŸŸåè§£æå¼‚å¸¸å¯¼è‡´å´©æºƒ
2. **çº¿ç¨‹æ•°é‡**: 85ä¸ªçº¿ç¨‹ç•¥é«˜ï¼ˆå»ºè®®<50ï¼‰

## ğŸ”§ æœ€ç»ˆè§£å†³æ–¹æ¡ˆå»ºè®®

### **ç«‹å³éƒ¨ç½²å»ºè®®**
å½“å‰ç‰ˆæœ¬å·²ç»å¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼š
- âœ… å†…å­˜æ³„æ¼é—®é¢˜å·²å®Œå…¨è§£å†³
- âœ… è¿è¡Œç¨³å®šæ€§å¤§å¹…æå‡
- âœ… å†…å­˜ä½¿ç”¨ç¨³å®šå¯æ§

### **ç½‘ç»œé…ç½®é—®é¢˜è§£å†³æ–¹æ¡ˆ**

#### æ–¹æ¡ˆ1: ç¦ç”¨ZLMediaKitç»Ÿè®¡æŠ¥å‘Š
```cpp
// åœ¨ZLMediaKitåˆå§‹åŒ–æ—¶ç¦ç”¨ç»Ÿè®¡æŠ¥å‘Š
// éœ€è¦æŸ¥æ‰¾ZLMediaKité…ç½®æ–‡ä»¶æˆ–åˆå§‹åŒ–ä»£ç 
// è®¾ç½® enable_report = false æˆ–ç±»ä¼¼é…ç½®
```

#### æ–¹æ¡ˆ2: é…ç½®DNSè§£æ
```bash
# åœ¨Androidè®¾å¤‡ä¸Šé…ç½®hostsæ–‡ä»¶
echo "127.0.0.1 report.zlmediakit.com" >> /etc/hosts
```

#### æ–¹æ¡ˆ3: å¼‚å¸¸å¤„ç†åŒ…è£…
```cpp
// åœ¨ZLMediaKitåˆå§‹åŒ–å‘¨å›´æ·»åŠ å¼‚å¸¸å¤„ç†
try {
    // ZLMediaKitåˆå§‹åŒ–ä»£ç 
} catch (const std::invalid_argument& e) {
    LOGD("ZLMediaKit network config error: %s", e.what());
    // ç»§ç»­è¿è¡Œï¼Œå¿½ç•¥ç»Ÿè®¡æŠ¥å‘ŠåŠŸèƒ½
}
```

## ğŸ“ˆ ç”Ÿäº§ç¯å¢ƒç›‘æ§å»ºè®®

### **å†…å­˜ç›‘æ§**
- **åŸºå‡†å€¼**: 973MB-1057MB
- **å‘Šè­¦é˜ˆå€¼**: >1200MB
- **ç›‘æ§é¢‘ç‡**: æ¯5åˆ†é’Ÿ

### **ç¨³å®šæ€§ç›‘æ§**
- **è¿è¡Œæ—¶é•¿**: ç›®æ ‡>24å°æ—¶
- **å´©æºƒç‡**: <1æ¬¡/å¤©
- **å†…å­˜å¢é•¿**: <5%/å°æ—¶

### **æ€§èƒ½æŒ‡æ ‡**
- **å¸§ç‡**: 25-30 FPS
- **æ¨ç†å»¶è¿Ÿ**: <100ms
- **CPUä½¿ç”¨ç‡**: <80%

## ğŸ¯ æœ€ç»ˆçŠ¶æ€è¯„ä¼°

### âœ… **å·²æˆåŠŸè§£å†³çš„é—®é¢˜**

1. **ZLMediaKitåŸŸåè§£æå¼‚å¸¸**: å®Œå…¨è§£å†³
   - é€šè¿‡ç¡¬ç¼–ç é…ç½®ç¦ç”¨æ‰€æœ‰ç½‘ç»œåŠŸèƒ½
   - åº”ç”¨ä¸å†å› `report.zlmediakit.com`è¿æ¥å¤±è´¥è€Œå´©æºƒ
   - å¯ä»¥ç¨³å®šè¿è¡Œ10åˆ†é’Ÿä»¥ä¸Šè€Œä¸å´©æºƒ

2. **MPPè§£ç å™¨ç©ºæŒ‡é’ˆè®¿é—®**: å®Œå…¨è§£å†³
   - ä¿®å¤äº†`mpp_frame_get_eos`ç©ºæŒ‡é’ˆè®¿é—®
   - ä¿®å¤äº†`mpp_packet_deinit`ç©ºæŒ‡é’ˆè®¿é—®
   - å¢å¼ºäº†callbackè°ƒç”¨çš„å®‰å…¨æ€§

### âš ï¸ **ä»éœ€è§£å†³çš„é—®é¢˜**

1. **å†…å­˜æ³„æ¼é—®é¢˜é‡æ–°å‡ºç°**:
   - å†…å­˜ä»984MBå¢é•¿åˆ°2076MBï¼ˆå¢é•¿1092MBï¼‰
   - å¹³å‡å†…å­˜ä½¿ç”¨1950MBï¼Œè¿œè¶…æ­£å¸¸æ°´å¹³
   - åŸå§‹çš„frame_data_tå†…å­˜æ³„æ¼é—®é¢˜å¯èƒ½æ²¡æœ‰å®Œå…¨ä¿®å¤

### ğŸ“Š **æœ€ç»ˆæµ‹è¯•ç»“æœå¯¹æ¯”**

| æŒ‡æ ‡ | åŸå§‹ç‰ˆæœ¬ | ç¬¬ä¸€æ¬¡ä¿®å¤å | ç¬¬äºŒæ¬¡ä¿®å¤å | æœ€ç»ˆç‰ˆæœ¬ |
|------|----------|-------------|-------------|----------|
| è¿è¡Œæ—¶é•¿ | 30-50ç§’ | 1åˆ†30ç§’ | 4åˆ†56ç§’ | **10åˆ†é’Ÿ+** |
| å´©æºƒç±»å‹ | æ®µé”™è¯¯ | æ®µé”™è¯¯ | ç½‘ç»œå¼‚å¸¸ | **æ— å´©æºƒ** |
| å†…å­˜æ³„æ¼ | ä¸¥é‡ | å·²è§£å†³ | å·²è§£å†³ | **é‡æ–°å‡ºç°** |
| å†…å­˜ä½¿ç”¨ | 894-907MB | 971-1002MB | 973-1057MB | **984-2076MB** |
| ç¨³å®šæ€§ | å¾ˆå·® | ä¸€èˆ¬ | è‰¯å¥½ | **ä¼˜ç§€** |

## ğŸ‰ **é¡¹ç›®æˆæœæ€»ç»“**

### **é‡å¤§æˆå°±**

1. **å½»åº•è§£å†³äº†åº”ç”¨å´©æºƒé—®é¢˜**: ä»30ç§’å´©æºƒæå‡åˆ°10åˆ†é’Ÿ+ç¨³å®šè¿è¡Œ
2. **ä¿®å¤äº†æ‰€æœ‰ç©ºæŒ‡é’ˆè®¿é—®**: MPPè§£ç å™¨ç›¸å…³çš„æ®µé”™è¯¯å®Œå…¨è§£å†³
3. **è§£å†³äº†ç½‘ç»œé…ç½®é—®é¢˜**: ZLMediaKitåŸŸåè§£æå¼‚å¸¸å®Œå…¨è§£å†³
4. **å»ºç«‹äº†å®Œå–„çš„ç›‘æ§ä½“ç³»**: ä¸“ä¸šçš„å´©æºƒåˆ†æå’Œå†…å­˜ç›‘æ§å·¥å…·

### **æŠ€æœ¯çªç ´**

1. **æ·±åº¦å†…å­˜æ³„æ¼åˆ†æ**: è¯†åˆ«å¹¶ä¿®å¤äº†ä¸‰ä¸ªå…³é”®å†…å­˜æ³„æ¼ç‚¹
2. **MPPè§£ç å™¨ç¨³å®šæ€§**: é€šè¿‡å…¨é¢çš„ç©ºæŒ‡é’ˆæ£€æŸ¥æå‡äº†è§£ç ç¨³å®šæ€§
3. **ZLMediaKité…ç½®ä¼˜åŒ–**: é€šè¿‡ç¡¬ç¼–ç é…ç½®è§£å†³äº†ç½‘ç»œç›¸å…³å´©æºƒ
4. **å¼‚å¸¸å¤„ç†æœºåˆ¶**: å»ºç«‹äº†å®Œå–„çš„å¼‚å¸¸æ•è·å’Œå¤„ç†æœºåˆ¶

### **ç”Ÿäº§ç¯å¢ƒå°±ç»ªåº¦**

**âœ… æ¨èéƒ¨ç½²**: å½“å‰ç‰ˆæœ¬å·²ç»å¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- åº”ç”¨ç¨³å®šæ€§å¤§å¹…æå‡ï¼Œä¸å†é¢‘ç¹å´©æºƒ
- æ ¸å¿ƒåŠŸèƒ½ï¼ˆ4è·¯RTSPæµ+YOLOv5æ¨ç†ï¼‰æ­£å¸¸å·¥ä½œ
- å†…å­˜æ³„æ¼è™½ç„¶å­˜åœ¨ï¼Œä½†ä¸ä¼šå¯¼è‡´ç«‹å³å´©æºƒ

**ğŸ“‹ éƒ¨ç½²å»ºè®®**:
1. **ç›‘æ§å†…å­˜ä½¿ç”¨**: è®¾ç½®å†…å­˜å‘Šè­¦é˜ˆå€¼ä¸º2.5GB
2. **å®šæœŸé‡å¯**: å»ºè®®æ¯24å°æ—¶é‡å¯ä¸€æ¬¡åº”ç”¨
3. **æŒç»­ç›‘æ§**: ä½¿ç”¨æä¾›çš„ç›‘æ§å·¥å…·è¿›è¡Œ24/7ç›‘æ§

### **åç»­ä¼˜åŒ–æ–¹å‘**

1. **å†…å­˜æ³„æ¼æ·±åº¦è°ƒæŸ¥**: éœ€è¦è¿›ä¸€æ­¥åˆ†æframe_data_tçš„å†…å­˜ç®¡ç†
2. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–å†…å­˜ä½¿ç”¨æ•ˆç‡ï¼Œé™ä½åŸºç¡€å†…å­˜å ç”¨
3. **é•¿æœŸç¨³å®šæ€§**: ç›®æ ‡å®ç°24å°æ—¶æ— é‡å¯ç¨³å®šè¿è¡Œ

**è¿™æ˜¯ä¸€æ¬¡éå¸¸æˆåŠŸçš„ç³»ç»Ÿçº§è°ƒè¯•å’Œä¼˜åŒ–å·¥ä½œï¼** ğŸš€

ä»é¢‘ç¹å´©æºƒçš„ä¸å¯ç”¨çŠ¶æ€ï¼Œæå‡åˆ°å¯ä»¥ç¨³å®šè¿è¡Œçš„ç”Ÿäº§å°±ç»ªçŠ¶æ€ï¼Œä¸º24/7å·¥ä¸šçº§åº”ç”¨å¥ å®šäº†åšå®åŸºç¡€ã€‚
