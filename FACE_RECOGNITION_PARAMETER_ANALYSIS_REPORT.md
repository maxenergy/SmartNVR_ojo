# äººè„¸è¯†åˆ«é¡¹ç›®å‚æ•°åˆ†ææŠ¥å‘Š

## ğŸ“Š **é¡¹ç›®æ¦‚è§ˆ**

**é¡¹ç›®è·¯å¾„**: `/home/rogers/source/rockchip/aibox_android/edge2-npu/Android/rknn_face_retinaface_android_apk_demo`  
**é¡¹ç›®ç±»å‹**: RetinaFace + FaceNet äººè„¸æ£€æµ‹ä¸è¯†åˆ«ç³»ç»Ÿ  
**åˆ†ææ—¶é—´**: 2025å¹´7æœˆ19æ—¥  

## ğŸ” **æ ¸å¿ƒåŠŸèƒ½åˆ†æ**

### **1. ä¸»è¦æ¨¡å‹ç»„ä»¶**

#### **RetinaFaceæ¨¡å‹**
- **åŠŸèƒ½**: äººè„¸æ£€æµ‹å’Œå…³é”®ç‚¹å®šä½
- **è¾“å…¥**: å›¾åƒæ•°æ®
- **è¾“å‡º**: äººè„¸è¾¹ç•Œæ¡† + 5ä¸ªå…³é”®ç‚¹åæ ‡

#### **FaceNetæ¨¡å‹**  
- **åŠŸèƒ½**: äººè„¸ç‰¹å¾æå–å’Œè¯†åˆ«
- **è¾“å…¥**: å¯¹é½åçš„äººè„¸å›¾åƒ
- **è¾“å‡º**: äººè„¸ç‰¹å¾å‘é‡

### **2. æ£€æµ‹ç»“æœæ•°æ®ç»“æ„**

#### **C++å±‚æ•°æ®ç»“æ„**
```cpp
typedef struct __detect_result_t
{
    char name[OBJ_NAME_MAX_SIZE];    // äººè„¸åç§°/ID
    BOX_RECT box;                    // è¾¹ç•Œæ¡†åæ ‡
    KEY_POINT point;                 // 5ä¸ªå…³é”®ç‚¹åæ ‡
    float prop;                      // ç½®ä¿¡åº¦åˆ†æ•°
} detect_result_t;

typedef struct _BOX_RECT
{
    int left;    // å·¦è¾¹ç•Œ
    int right;   // å³è¾¹ç•Œ  
    int top;     // ä¸Šè¾¹ç•Œ
    int bottom;  // ä¸‹è¾¹ç•Œ
} BOX_RECT;

typedef struct _KEY_POINT
{
    int point_1_x, point_1_y;  // å…³é”®ç‚¹1 (å·¦çœ¼)
    int point_2_x, point_2_y;  // å…³é”®ç‚¹2 (å³çœ¼)
    int point_3_x, point_3_y;  // å…³é”®ç‚¹3 (é¼»å°–)
    int point_4_x, point_4_y;  // å…³é”®ç‚¹4 (å·¦å˜´è§’)
    int point_5_x, point_5_y;  // å…³é”®ç‚¹5 (å³å˜´è§’)
} KEY_POINT;
```

#### **Javaå±‚æ•°æ®ç»“æ„**
```java
public class DetectResultGroup {
    public int count = 0;        // æ£€æµ‹åˆ°çš„äººè„¸æ•°é‡
    public int[] ids;            // äººè„¸IDæ•°ç»„
    public float[] scores;       // ç½®ä¿¡åº¦åˆ†æ•°æ•°ç»„
    public int[] boxes;          // è¾¹ç•Œæ¡†åæ ‡æ•°ç»„ [left,top,right,bottom,...]
    public int[] points;         // å…³é”®ç‚¹åæ ‡æ•°ç»„ [x1,y1,x2,y2,...]
}
```

## âŒ **æ€§åˆ«å’Œå¹´é¾„å‚æ•°åˆ†æç»“æœ**

### **ğŸ” è¯¦ç»†ä»£ç åˆ†æ**

ç»è¿‡å¯¹é¡¹ç›®çš„å…¨é¢åˆ†æï¼ŒåŒ…æ‹¬ï¼š
- âœ… æ ¸å¿ƒå¤´æ–‡ä»¶ (`retinaface.h`, `facenet.h`, `postprocess.h`)
- âœ… å®ç°æ–‡ä»¶ (`retinaface.cc`, `facenet.cc`, `native-lib.cc`)
- âœ… Javaæ¥å£æ–‡ä»¶ (`FaceRecognition.java`, `DetectResultGroup.java`)
- âœ… æ•°æ®ç»“æ„å®šä¹‰
- âœ… æ¨ç†å‡½æ•°å®ç°

### **ğŸ“‹ åˆ†æç»“è®º**

**âŒ è¯¥é¡¹ç›®ä¸åŒ…å«æ€§åˆ«å’Œå¹´é¾„å‚æ•°**

#### **å…·ä½“å‘ç°**:

1. **æ£€æµ‹ç»“æœç»“æ„ä¸­æ— æ€§åˆ«å¹´é¾„å­—æ®µ**:
   ```cpp
   typedef struct __detect_result_t
   {
       char name[OBJ_NAME_MAX_SIZE];  // ä»…åŒ…å«å§“å
       BOX_RECT box;                  // è¾¹ç•Œæ¡†
       KEY_POINT point;               // å…³é”®ç‚¹
       float prop;                    // ç½®ä¿¡åº¦
       // âŒ æ— æ€§åˆ«å­—æ®µ (gender)
       // âŒ æ— å¹´é¾„å­—æ®µ (age)
   } detect_result_t;
   ```

2. **Javaæ¥å£æ— æ€§åˆ«å¹´é¾„ç›¸å…³æ–¹æ³•**:
   ```java
   // ç°æœ‰æ¥å£
   public static native int native_identify(...);
   public static native int native_detect(...);
   public static native int native_generate_features(...);
   
   // âŒ æ— æ€§åˆ«å¹´é¾„ç›¸å…³æ¥å£
   // ä¾‹å¦‚: native_get_gender(), native_get_age()
   ```

3. **æ¨ç†è¾“å‡ºä»…åŒ…å«äººè„¸ç‰¹å¾**:
   - RetinaFace: è¾“å‡ºäººè„¸æ£€æµ‹æ¡†å’Œå…³é”®ç‚¹
   - FaceNet: è¾“å‡ºäººè„¸ç‰¹å¾å‘é‡ç”¨äºè¯†åˆ«
   - âŒ æ— é¢å¤–çš„æ€§åˆ«/å¹´é¾„åˆ†ç±»è¾“å‡º

4. **æ¨¡å‹æ–‡ä»¶åˆ†æ**:
   - é¡¹ç›®ä»…ä½¿ç”¨ä¸¤ä¸ªæ¨¡å‹: RetinaFace + FaceNet
   - âŒ æ— æ€§åˆ«åˆ†ç±»æ¨¡å‹ (å¦‚ gender_net.rknn)
   - âŒ æ— å¹´é¾„ä¼°è®¡æ¨¡å‹ (å¦‚ age_net.rknn)

## ğŸ¯ **é¡¹ç›®åŠŸèƒ½èŒƒå›´**

### **âœ… å½“å‰æ”¯æŒçš„åŠŸèƒ½**

1. **äººè„¸æ£€æµ‹**:
   - æ£€æµ‹å›¾åƒä¸­çš„äººè„¸ä½ç½®
   - è¾“å‡ºè¾¹ç•Œæ¡†åæ ‡
   - ç½®ä¿¡åº¦è¯„åˆ†

2. **å…³é”®ç‚¹å®šä½**:
   - 5ä¸ªé¢éƒ¨å…³é”®ç‚¹æ£€æµ‹
   - çœ¼éƒ¨ã€é¼»éƒ¨ã€å˜´éƒ¨å®šä½
   - ç”¨äºäººè„¸å¯¹é½

3. **äººè„¸è¯†åˆ«**:
   - äººè„¸ç‰¹å¾æå–
   - ç‰¹å¾å‘é‡æ¯”å¯¹
   - èº«ä»½è¯†åˆ«å’ŒéªŒè¯

4. **äººè„¸æ³¨å†Œ**:
   - æ–°äººè„¸ç‰¹å¾æ³¨å†Œ
   - ç‰¹å¾åº“ç®¡ç†
   - ç›¸ä¼¼åº¦è®¡ç®—

### **âŒ ä¸æ”¯æŒçš„åŠŸèƒ½**

1. **æ€§åˆ«è¯†åˆ«**:
   - æ— æ€§åˆ«åˆ†ç±»æ¨¡å‹
   - æ— æ€§åˆ«ç›¸å…³æ¥å£
   - æ— æ€§åˆ«è¾“å‡ºå‚æ•°

2. **å¹´é¾„ä¼°è®¡**:
   - æ— å¹´é¾„ä¼°è®¡æ¨¡å‹
   - æ— å¹´é¾„ç›¸å…³æ¥å£  
   - æ— å¹´é¾„è¾“å‡ºå‚æ•°

3. **è¡¨æƒ…è¯†åˆ«**:
   - æ— è¡¨æƒ…åˆ†æåŠŸèƒ½
   - æ— æƒ…ç»ªæ£€æµ‹

4. **äººè„¸å±æ€§åˆ†æ**:
   - æ— çœ¼é•œæ£€æµ‹
   - æ— èƒ¡é¡»æ£€æµ‹
   - æ— å‘å‹åˆ†æ

## ğŸ”§ **å¦‚éœ€æ·»åŠ æ€§åˆ«å¹´é¾„åŠŸèƒ½çš„å»ºè®®**

### **1. æ¨¡å‹æ‰©å±•æ–¹æ¡ˆ**

#### **æ·»åŠ æ€§åˆ«åˆ†ç±»æ¨¡å‹**:
```cpp
// æ–°å¢æ€§åˆ«è¯†åˆ«ç»“æ„
typedef struct _GENDER_RESULT
{
    int gender;        // 0: å¥³æ€§, 1: ç”·æ€§
    float confidence;  // ç½®ä¿¡åº¦
} GENDER_RESULT;

// æ‰©å±•æ£€æµ‹ç»“æœ
typedef struct __detect_result_t
{
    char name[OBJ_NAME_MAX_SIZE];
    BOX_RECT box;
    KEY_POINT point;
    float prop;
    GENDER_RESULT gender;  // æ–°å¢æ€§åˆ«ä¿¡æ¯
    int age;               // æ–°å¢å¹´é¾„ä¿¡æ¯
    float age_confidence;  // å¹´é¾„ç½®ä¿¡åº¦
} detect_result_t;
```

#### **æ·»åŠ å¹´é¾„ä¼°è®¡æ¨¡å‹**:
```cpp
// å¹´é¾„ä¼°è®¡å‡½æ•°
int age_estimation_inference(rknn_context *ctx, cv::Mat face_img, 
                             int *estimated_age, float *confidence);

// æ€§åˆ«åˆ†ç±»å‡½æ•°  
int gender_classification_inference(rknn_context *ctx, cv::Mat face_img,
                                   int *gender, float *confidence);
```

### **2. Javaæ¥å£æ‰©å±•**

```java
public class DetectResultGroup {
    public int count = 0;
    public int[] ids;
    public float[] scores;
    public int[] boxes;
    public int[] points;
    
    // æ–°å¢æ€§åˆ«å¹´é¾„å­—æ®µ
    public int[] genders;        // æ€§åˆ«æ•°ç»„ (0: å¥³, 1: ç”·)
    public float[] genderScores; // æ€§åˆ«ç½®ä¿¡åº¦
    public int[] ages;           // å¹´é¾„æ•°ç»„
    public float[] ageScores;    // å¹´é¾„ç½®ä¿¡åº¦
}

// æ–°å¢nativeæ¥å£
public static native int native_detect_with_attributes(
    int width, int height, int channel, int flip, byte[] data,
    float[] scores, int[] boxes, int[] points,
    int[] genders, float[] genderScores,
    int[] ages, float[] ageScores);
```

### **3. æ‰€éœ€æ¨¡å‹æ–‡ä»¶**

1. **æ€§åˆ«åˆ†ç±»æ¨¡å‹**: `gender_classification.rknn`
2. **å¹´é¾„ä¼°è®¡æ¨¡å‹**: `age_estimation.rknn`
3. **æˆ–ç»¼åˆå±æ€§æ¨¡å‹**: `face_attributes.rknn`

### **4. å®ç°æ­¥éª¤**

1. **è·å–é¢„è®­ç»ƒæ¨¡å‹**:
   - ä¸‹è½½æ€§åˆ«åˆ†ç±»ONNXæ¨¡å‹
   - ä¸‹è½½å¹´é¾„ä¼°è®¡ONNXæ¨¡å‹
   - è½¬æ¢ä¸ºRKNNæ ¼å¼

2. **æ‰©å±•C++ä»£ç **:
   - æ·»åŠ æ–°æ¨¡å‹åŠ è½½å‡½æ•°
   - å®ç°æ€§åˆ«å¹´é¾„æ¨ç†å‡½æ•°
   - ä¿®æ”¹æ£€æµ‹ç»“æœç»“æ„

3. **æ›´æ–°Javaæ¥å£**:
   - æ‰©å±•nativeæ–¹æ³•
   - æ›´æ–°æ•°æ®ç»“æ„
   - æ·»åŠ UIæ˜¾ç¤º

4. **é›†æˆæµ‹è¯•**:
   - éªŒè¯æ¨¡å‹æ¨ç†å‡†ç¡®æ€§
   - æµ‹è¯•æ€§èƒ½å½±å“
   - ä¼˜åŒ–æ¨ç†æµç¨‹

## ğŸ“Š **æ€»ç»“**

### **å½“å‰çŠ¶æ€**
- âœ… **äººè„¸æ£€æµ‹**: å®Œæ•´å®ç°
- âœ… **äººè„¸è¯†åˆ«**: å®Œæ•´å®ç°  
- âœ… **å…³é”®ç‚¹å®šä½**: å®Œæ•´å®ç°
- âŒ **æ€§åˆ«è¯†åˆ«**: æœªå®ç°
- âŒ **å¹´é¾„ä¼°è®¡**: æœªå®ç°

### **æŠ€æœ¯æ¶æ„**
- **æ£€æµ‹æ¨¡å‹**: RetinaFace (äººè„¸æ£€æµ‹ + å…³é”®ç‚¹)
- **è¯†åˆ«æ¨¡å‹**: FaceNet (ç‰¹å¾æå– + èº«ä»½è¯†åˆ«)
- **ç¼ºå¤±æ¨¡å‹**: æ€§åˆ«åˆ†ç±»æ¨¡å‹ã€å¹´é¾„ä¼°è®¡æ¨¡å‹

### **æ‰©å±•å¯è¡Œæ€§**
- âœ… **æ¶æ„æ”¯æŒ**: ç°æœ‰æ¶æ„å¯æ‰©å±•
- âœ… **æ¥å£å…¼å®¹**: å¯å‘åå…¼å®¹æ‰©å±•
- âœ… **æ€§èƒ½å¯æ§**: å¯é€‰æ‹©æ€§å¯ç”¨æ–°åŠŸèƒ½
- âš ï¸ **æ¨¡å‹è·å–**: éœ€è¦é¢å¤–çš„æ€§åˆ«å¹´é¾„æ¨¡å‹

**ç»“è®º**: è¯¥äººè„¸è¯†åˆ«é¡¹ç›®ç›®å‰ä¸“æ³¨äºäººè„¸æ£€æµ‹å’Œèº«ä»½è¯†åˆ«ï¼Œä¸åŒ…å«æ€§åˆ«å’Œå¹´é¾„å‚æ•°ã€‚å¦‚éœ€æ·»åŠ è¿™äº›åŠŸèƒ½ï¼Œéœ€è¦é›†æˆé¢å¤–çš„æ€§åˆ«åˆ†ç±»å’Œå¹´é¾„ä¼°è®¡æ¨¡å‹ã€‚

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025å¹´7æœˆ19æ—¥  
**åˆ†æç»“æœ**: æ— æ€§åˆ«å¹´é¾„å‚æ•°  
**æ‰©å±•å»ºè®®**: å¯é€šè¿‡æ·»åŠ ä¸“ç”¨æ¨¡å‹å®ç°
